# å¼€å‘å‚è€ƒ

æœ¬æ–‡æ¡£è®°å½•ç³»ç»Ÿå½“å‰æ¶æ„ã€æ‰€æœ‰æºæ–‡ä»¶ä½œç”¨åŠåç«¯å®Œæ•´ API åˆ—è¡¨ï¼Œä¾›å¼€å‘è€…å‚è€ƒã€‚

---

## ç³»ç»Ÿæ¶æ„å›¾

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                                â”‚
â”‚                                                                  â”‚
â”‚  React 19 + TypeScript + Vite + Tailwind CSS + Zustand          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é¦–é¡µæ”¾é€  â”‚  â”‚ æœç´¢/ä¸‹è½½ â”‚  â”‚  è®¢é˜…ç®¡ç† â”‚  â”‚   ç³»ç»Ÿè®¾ç½®   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                          authFetch()                            â”‚
â”‚                     (Bearer JWT + 401 é‡å®šå‘)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP / JSON
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ASP.NET Core 9 åç«¯                          â”‚
â”‚                      localhost:5072                              â”‚
â”‚                                                                  â”‚
â”‚  Middleware Pipeline:                                           â”‚
â”‚  CorrelationId â†’ ExceptionHandler â†’ PerfMonitor â†’ ReqLogging   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Controllers                          â”‚  â”‚
â”‚  â”‚  AnimeController  â”‚ AuthController  â”‚ SubscriptionCtrl   â”‚  â”‚
â”‚  â”‚  MikanController  â”‚ AdminController â”‚ SettingsController  â”‚  â”‚
â”‚  â”‚                   HealthController                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Services Layer                         â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  AnimeAggregationService   SubscriptionService            â”‚  â”‚
â”‚  â”‚  AnimePoolService          AuthService                     â”‚  â”‚
â”‚  â”‚  QBittorrentService        MikanClient                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                          â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Repositories      â”‚  â”‚      Background Services           â”‚  â”‚
â”‚  â”‚   AnimeRepository   â”‚  â”‚  AnimePreFetchService (æ¯æ—¥03:00)  â”‚  â”‚
â”‚  â”‚ SubscriptionRepo    â”‚  â”‚  RssPollingService   (æ¯30åˆ†é’Ÿ)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  DownloadProgressSync (å®æ—¶åŒæ­¥)   â”‚  â”‚
â”‚             â”‚              â”‚  AnimeTitleBackfill  (è¡¥å…¨æ ‡é¢˜)    â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  MikanFeedCleanup    (æ¸…ç†ç¼“å­˜)   â”‚  â”‚
â”‚  â”‚   SQLite Database   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚   (anime.db)        â”‚                                          â”‚
â”‚  â”‚                     â”‚                                          â”‚
â”‚  â”‚  AnimeInfo          â”‚                                          â”‚
â”‚  â”‚  AnimeImages        â”‚                                          â”‚
â”‚  â”‚  Subscriptions      â”‚                                          â”‚
â”‚  â”‚  DownloadHistory    â”‚                                          â”‚
â”‚  â”‚  DailyScheduleCache â”‚                                          â”‚
â”‚  â”‚  MikanFeedCache     â”‚                                          â”‚
â”‚  â”‚  MikanFeedItem      â”‚                                          â”‚
â”‚  â”‚  MikanSubgroup      â”‚                                          â”‚
â”‚  â”‚  TopAnimeCache      â”‚                                          â”‚
â”‚  â”‚  User               â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bangumi API   â”‚  â”‚    TMDB API      â”‚  â”‚   AniList GraphQL   â”‚
â”‚ api.bgm.tv/v0   â”‚  â”‚ api.tmdb.org/3   â”‚  â”‚  graphql.anilist.co â”‚
â”‚                 â”‚  â”‚                  â”‚  â”‚                     â”‚
â”‚ æ¯æ—¥æ”¾é€æ—¶é—´è¡¨  â”‚  â”‚ è‹±æ–‡å…ƒæ•°æ®       â”‚  â”‚ è‹±æ–‡æ ‡é¢˜/ç®€ä»‹       â”‚
â”‚ è¯„åˆ†æ’è¡Œæ¦œ      â”‚  â”‚ æ¨ªç‰ˆèƒŒæ™¯å›¾       â”‚  â”‚ è¶‹åŠ¿æ’è¡Œæ¦œ          â”‚
â”‚ åŠ¨æ¼«è¯¦æƒ…        â”‚  â”‚ æ™ºèƒ½å­£åº¦åŒ¹é…     â”‚  â”‚ (å¤‡ç”¨æ¥æº)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Jikan API     â”‚       â”‚     Mikan RSS         â”‚
â”‚ api.jikan.moe   â”‚       â”‚   mikanani.me         â”‚
â”‚                 â”‚       â”‚                       â”‚
â”‚ MAL Top 10      â”‚       â”‚ ç•ªå‰§ RSS ç§å­åˆ—è¡¨     â”‚
â”‚ (MyAnimeList)   â”‚       â”‚ å­—å¹•ç»„åˆ†ç»„ä¿¡æ¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    qBittorrent WebUI  â”‚
                          â”‚    localhost:8080      â”‚
                          â”‚                       â”‚
                          â”‚  ç§å­æ·»åŠ /æš‚åœ/æ¢å¤   â”‚
                          â”‚  ä¸‹è½½è¿›åº¦æŸ¥è¯¢         â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®èšåˆæµç¨‹

```
GET /api/anime/today
        â”‚
        â–¼
AnimeAggregationService
        â”‚
        â”œâ”€â‘  æŸ¥è¯¢ SQLite (GetAnimesByWeekdayAsync)
        â”‚         â”‚
        â”‚    æœ‰é¢„å–æ•°æ®? â”€â”€æ˜¯â”€â”€â–º è¿”å› DB æ•°æ® (<100ms)
        â”‚         â”‚
        â”‚         å¦
        â”‚         â–¼
        â”œâ”€â‘¡ Bangumi API
        â”‚   GET /v0/calendar â†’ è·å–æœ¬å‘¨æ”¾é€
        â”‚   æ¯éƒ¨ç•ªå‰§: id, name, air_date, score, å°é¢å›¾
        â”‚         â”‚
        â”œâ”€â‘¢ TMDB API (å¹¶å‘)
        â”‚   æœç´¢ç•ªå‰§å â†’ æ™ºèƒ½åŒ¹é… (Animationä¼˜å…ˆ/JPä¼˜å…ˆ/å¹´ä»½è¿‡æ»¤)
        â”‚   GET /3/search/tv â†’ GET /3/tv/{id}/season/{n}
        â”‚   æå–: è‹±æ–‡æ ‡é¢˜, è‹±æ–‡ç®€ä»‹, æ¨ªç‰ˆèƒŒæ™¯å›¾
        â”‚         â”‚
        â””â”€â‘£ AniList GraphQL (å¤‡ç”¨)
            query { Media } â†’ è‹±æ–‡æ ‡é¢˜/ç®€ä»‹ (Bangumiæœ‰æ•°æ®æ—¶è·³è¿‡)
                    â”‚
                    â–¼
             AnimeInfo[] â†’ è¿”å›å‰ç«¯ â†’ ç¼“å­˜è‡³ sessionStorage
```

### é¢„å–æ¶æ„

```
AnimePreFetchService (BackgroundService)
        â”‚
        â”œâ”€â”€ å¯åŠ¨æ—¶: RunOnStartup=true â†’ ç«‹å³æ‰§è¡Œä¸€æ¬¡
        â”‚
        â””â”€â”€ å®šæ—¶: æ¯å¤© ScheduleHour (é»˜è®¤å‡Œæ™¨3ç‚¹)
                  â”‚
                  â”œâ”€ GetFullCalendarAsync() â†’ è·å–å…¨å‘¨ Bangumi æ•°æ®
                  â”œâ”€ å¹¶å‘èšåˆ (MaxConcurrency=3)
                  â”‚   æ¯éƒ¨ç•ªå‰§ â†’ TMDB + AniList ä¸°å¯Œå…ƒæ•°æ®
                  â””â”€ æ‰¹é‡å†™å…¥ SQLite
                     è®¾ç½® IsPreFetched=true
```

### è®¢é˜…ä¸‹è½½æµç¨‹

```
RssPollingService (æ¯30åˆ†é’Ÿ)
        â”‚
        â”œâ”€ æ£€æŸ¥ EnablePolling é…ç½®
        â”‚
        â””â”€ éå†æ‰€æœ‰ IsEnabled=true çš„è®¢é˜…
                  â”‚
                  â–¼
          MikanClient.GetFeedAsync(mikanBangumiId, subgroupId)
                  â”‚
                  â–¼
          è§£æ RSS XML â†’ MikanFeedItem[]
                  â”‚
                  â–¼
          è¿‡æ»¤æµç¨‹:
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. TorrentHash âˆˆ DownloadHistory?  â”‚
          â”‚    æ˜¯ â†’ è·³è¿‡ (å·²ä¸‹è½½)              â”‚
          â”‚    å¦ â†’ ç»§ç»­                        â”‚
          â”‚ 2. å­—å¹•ç»„ ID åŒ¹é…?                 â”‚
          â”‚    ä¸åŒ¹é… â†’ è·³è¿‡                   â”‚
          â”‚ 3. KeywordInclude å…¨éƒ¨å‘½ä¸­?        â”‚
          â”‚    å¦ â†’ è·³è¿‡                        â”‚
          â”‚ 4. KeywordExclude ä»»ä¸€å‘½ä¸­?        â”‚
          â”‚    æ˜¯ â†’ è·³è¿‡                        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼ (é€šè¿‡è¿‡æ»¤)
          QBittorrentService.AddTorrentAsync()
                  â”‚
                  â–¼
          å†™å…¥ DownloadHistory (Status=Downloading)
          æ›´æ–° Subscription.LastDownloadAt
```

---

## åç«¯æ–‡ä»¶æ¸…å•

### Controllers

| æ–‡ä»¶ | è·¯ç”±å‰ç¼€ | è¯´æ˜ |
|------|----------|------|
| `Controllers/AnimeController.cs` | `/api/anime` | åŠ¨æ¼«æ•°æ®èšåˆï¼šä»Šæ—¥æ”¾é€ã€Top10ã€æœç´¢ã€éšæœºæ¨èã€æ‰¹é‡æŸ¥è¯¢ |
| `Controllers/AuthController.cs` | `/api/auth` | è®¤è¯ç³»ç»Ÿï¼šç™»å½•ã€æ³¨å†Œã€å®‰è£…å‘å¯¼ã€ä¿®æ”¹å¯†ç ã€èƒŒæ™¯å›¾ç®¡ç† |
| `Controllers/SubscriptionController.cs` | `/api/subscription` | è®¢é˜…ç®¡ç†ï¼šCRUDã€æ‰‹åŠ¨æ£€æŸ¥ã€ä¸‹è½½å†å²ã€ä»»åŠ¡ Hash æŸ¥è¯¢ |
| `Controllers/MikanController.cs` | `/api/mikan` | Mikan æ“ä½œï¼šRSS æœç´¢/è§£æ/è¿‡æ»¤ã€ç§å­ä¸‹è½½ã€qBittorrent æ§åˆ¶ |
| `Controllers/AdminController.cs` | `/api/admin` | ç®¡ç†æ¥å£ï¼šé¢„å–çŠ¶æ€ã€æ‰‹åŠ¨è§¦å‘é¢„å–ã€æ•°æ®åº“ç»Ÿè®¡ã€æ¸…ç©ºæ•°æ® |
| `Controllers/SettingsController.cs` | `/api/settings` | è®¾ç½®ç®¡ç†ï¼šToken è¯»å†™ã€ç”¨æˆ·é…ç½®ã€è¿æ¥æµ‹è¯• |
| `Controllers/HealthController.cs` | `/health` | å¥åº·æ£€æŸ¥ï¼šåŸºç¡€å¿ƒè·³ã€å¤–éƒ¨ API ä¾èµ–æ£€æŸ¥ |

### Services/Interfaces

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `IAnimeAggregationService.cs` | æ•°æ®èšåˆæœåŠ¡æ¥å£ï¼šå®šä¹‰ä»Šæ—¥æ”¾é€ã€Top10ã€æœç´¢ç­‰èšåˆæ–¹æ³• |
| `IAnimePoolService.cs` | éšæœºæ¨èæ± æ¥å£ï¼šè·å–éšæœºç•ªå‰§åˆ—è¡¨ |
| `IAniListClient.cs` | AniList GraphQL å®¢æˆ·ç«¯æ¥å£ |
| `IBangumiClient.cs` | Bangumi HTTP å®¢æˆ·ç«¯æ¥å£ï¼šæ”¾é€ã€æ’è¡Œã€è¯¦æƒ… |
| `IJikanClient.cs` | Jikanï¼ˆMALï¼‰HTTP å®¢æˆ·ç«¯æ¥å£ |
| `IMikanClient.cs` | Mikan RSS å®¢æˆ·ç«¯æ¥å£ï¼šæœç´¢ã€è§£æã€å­—å¹•ç»„ |
| `IQBittorrentService.cs` | qBittorrent WebUI æ¥å£ï¼šæ·»åŠ /æš‚åœ/æ¢å¤/åˆ é™¤/æŸ¥è¯¢ |
| `ISubscriptionService.cs` | è®¢é˜…ä¸šåŠ¡é€»è¾‘æ¥å£ |
| `ITMDBClient.cs` | TMDB API å®¢æˆ·ç«¯æ¥å£ï¼šæœç´¢ã€å­£åº¦å›¾ç‰‡ |
| `IAuthService.cs` | è®¤è¯æœåŠ¡æ¥å£ï¼šç™»å½•éªŒè¯ã€JWT ç”Ÿæˆã€å¯†ç ä¿®æ”¹ |
| `ITorrentTitleParser.cs` | ç§å­æ ‡é¢˜è§£ææ¥å£ï¼šæå–é›†æ•°ã€åˆ†è¾¨ç‡ã€å­—å¹•ç»„ |

### Services/Implementations

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `AnimeAggregationService.cs` | æ ¸å¿ƒèšåˆæœåŠ¡ï¼šåè°ƒ Bangumiâ†’TMDBâ†’AniList æ•°æ®ï¼ŒDB ä¼˜å…ˆè¯»å– |
| `AnimePoolService.cs` | éšæœºæ¨èæ± ï¼šå†…å­˜ç¼“å­˜ + SQLite L2 å¤‡é€‰ï¼Œå¯åŠ¨æ—¶é¢„çƒ­ |
| `AnimePoolBuilderService.cs` | æ¨èæ± æ„å»ºå™¨ï¼šä» AniList è·å–çƒ­é—¨ç•ªå‰§å¡«å……æ¨èæ±  |
| `AniListClient.cs` | AniList GraphQL å®¢æˆ·ç«¯å®ç°ï¼štrending æŸ¥è¯¢ã€æ ‡é¢˜/ç®€ä»‹æå– |
| `BangumiClient.cs` | Bangumi API å®ç°ï¼š`/v0/calendar`ã€`/v0/subjects` æ’è¡Œ |
| `JikanClient.cs` | Jikan API å®ç°ï¼š`/v4/top/anime` MAL æ’è¡Œ |
| `MikanClient.cs` | Mikan å®ç°ï¼šHtmlAgilityPack è§£æç•ªå‰§é¡µã€XML è§£æ RSS |
| `QBittorrentService.cs` | qBittorrent WebUI API å°è£…ï¼šç™»å½• cookie ç®¡ç†ã€ç§å­æ“ä½œ |
| `SubscriptionService.cs` | è®¢é˜…ä¸šåŠ¡é€»è¾‘ï¼šCRUDã€RSS æ£€æŸ¥ã€å…³é”®è¯è¿‡æ»¤ |
| `TMDBClient.cs` | TMDB å®ç°ï¼šTV æœç´¢ + Animation ä¼˜å…ˆåŒ¹é… + å­£åº¦å›¾ç‰‡ |

### Services/Background

| æ–‡ä»¶ | è§¦å‘æ—¶æœº | è¯´æ˜ |
|------|----------|------|
| `AnimePreFetchService.cs` | å¯åŠ¨æ—¶ + æ¯æ—¥å‡Œæ™¨3ç‚¹ | æ‰¹é‡é¢„å–å…¨å‘¨æ”¾é€æ•°æ®å†™å…¥ SQLite |
| `RssPollingService.cs` | å¯åŠ¨30ç§’å + æ¯30åˆ†é’Ÿ | æ£€æŸ¥æ‰€æœ‰è®¢é˜… RSSï¼Œè‡ªåŠ¨ä¸‹è½½æ–°ç§å­ |
| `DownloadProgressSyncService.cs` | åå°æŒç»­è¿è¡Œ | å®šæœŸåŒæ­¥ qBittorrent ä¸‹è½½è¿›åº¦åˆ° DownloadHistory |
| `AnimeTitleBackfillService.cs` | å¯åŠ¨æ—¶ | è¡¥å…¨æ•°æ®åº“ä¸­ç¼ºå¤±çš„ä¸­æ–‡æ ‡é¢˜ï¼ˆBangumi fallbackï¼‰ |
| `MikanFeedSubgroupCleanupService.cs` | å®šæœŸ | æ¸…ç†è¿‡æœŸçš„ Mikan Feed ç¼“å­˜æ•°æ® |

### Services/Repositories

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `IAnimeRepository.cs` / `AnimeRepository.cs` | åŠ¨æ¼«æ•°æ®è®¿é—®ï¼šæŒ‰æ˜ŸæœŸæŸ¥è¯¢ã€æ‰¹é‡å†™å…¥ã€Top ç¼“å­˜ç®¡ç† |
| `ISubscriptionRepository.cs` / `SubscriptionRepository.cs` | è®¢é˜…æ•°æ®è®¿é—®ï¼šCRUDã€æŒ‰ Bangumi ID æŸ¥è¯¢ã€å†å²è®°å½• |

### Servicesï¼ˆå·¥å…·ç±»ï¼‰

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ApiClientBase.cs` | HTTP å®¢æˆ·ç«¯åŸºç±»ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€BaseAddress ç®¡ç† |
| `AnimeCacheService.cs` | ä¸¤çº§ç¼“å­˜ï¼šMemory Cacheï¼ˆL1ï¼‰+ SQLiteï¼ˆL2ï¼‰ |
| `AuthService.cs` | JWT ç”Ÿæˆï¼ˆHMAC-SHA256ï¼‰ã€bcrypt å¯†ç å“ˆå¸Œã€ç”¨æˆ·éªŒè¯ |
| `HealthCheckService.cs` | å¤–éƒ¨ API ä¾èµ–æ£€æŸ¥ï¼ˆBangumi/TMDB/AniList è¿é€šæ€§ï¼‰ |
| `TokenStorageService.cs` | TMDB Token åŠ å¯†å­˜å‚¨ï¼ˆASP.NET Data Protection APIï¼‰ |
| `ResilienceService.cs` | Polly é‡è¯•ç­–ç•¥ + ç†”æ–­å™¨ï¼Œä¿æŠ¤å¤–éƒ¨ API è°ƒç”¨ |

### Services/Utilities

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Utilities/TitleCleaner.cs` | åŠ¨æ¼«æ ‡é¢˜è§„èŒƒåŒ–ï¼šå»é™¤å™ªå£°å­—ç¬¦ã€ç»Ÿä¸€æ ¼å¼ |
| `Utilities/TitleLanguageResolver.cs` | æ ‡é¢˜è¯­è¨€æ£€æµ‹ï¼šåˆ¤æ–­ä¸­/æ—¥/è‹±æ–‡ |
| `Utils/TorrentHashHelper.cs` | ç§å­ Hash è®¡ç®—è¾…åŠ© |

### Services/Exceptions

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ApiException.cs` | é€šç”¨ API å¼‚å¸¸åŸºç±» |
| `BangumiApiException.cs` | Bangumi API ä¸“å±å¼‚å¸¸ |
| `ExternalApiException.cs` | å¤–éƒ¨ API è°ƒç”¨å¤±è´¥å¼‚å¸¸ |
| `InvalidCredentialsException.cs` | è®¤è¯å‡­æ®æ— æ•ˆå¼‚å¸¸ |
| `QBittorrentUnavailableException.cs` | qBittorrent è¿æ¥ä¸å¯ç”¨å¼‚å¸¸ |
| `ValidationException.cs` | è¯·æ±‚æ•°æ®éªŒè¯å¤±è´¥å¼‚å¸¸ |

### Dataï¼ˆæ•°æ®å±‚ï¼‰

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Data/AnimeDbContext.cs` | EF Core SQLite ä¸Šä¸‹æ–‡ï¼Œå®šä¹‰æ‰€æœ‰ DbSet |
| `Data/DbSchemaPatcher.cs` | è½»é‡æ•°æ®åº“ Schema è¿ç§»ï¼ˆè¡¥ä¸æ¨¡å¼ï¼‰ |
| `Data/Entities/AnimeInfoEntity.cs` | èšåˆåŠ¨æ¼«ä¿¡æ¯ï¼ˆæ ‡é¢˜/è¯„åˆ†/å›¾ç‰‡/é“¾æ¥/æ˜ŸæœŸ/é¢„å–çŠ¶æ€ï¼‰ |
| `Data/Entities/AnimeImagesEntity.cs` | å›¾ç‰‡ç¼“å­˜ï¼ˆç«–ç‰ˆå°é¢ + æ¨ªç‰ˆèƒŒæ™¯å›¾ï¼‰ |
| `Data/Entities/DailyScheduleCacheEntity.cs` | æ¯æ—¥æ”¾é€ç¼“å­˜ï¼ˆæ—¥æœŸ â†’ Bangumi ID æ•°ç»„ï¼‰ |
| `Data/Entities/DownloadHistoryEntity.cs` | ä¸‹è½½å†å²ï¼ˆHash å»é‡ã€çŠ¶æ€è¿½è¸ªï¼‰ |
| `Data/Entities/DownloadSource.cs` | æšä¸¾ï¼šSubscription / Manual |
| `Data/Entities/MikanFeedCacheEntity.cs` | Mikan RSS Feed ç¼“å­˜ |
| `Data/Entities/MikanFeedItemEntity.cs` | å•æ¡ Feed è®°å½•ï¼ˆç§å­æ ‡é¢˜/URL/Hashï¼‰ |
| `Data/Entities/MikanSubgroupEntity.cs` | å­—å¹•ç»„ ID â†” åç§°æ˜ å°„ç¼“å­˜ |
| `Data/Entities/SubscriptionEntity.cs` | è®¢é˜…é…ç½®ï¼ˆç•ªå‰§/å­—å¹•ç»„/å…³é”®è¯/çŠ¶æ€ï¼‰ |
| `Data/Entities/TopAnimeCacheEntity.cs` | Top 10 æ’è¡Œç¼“å­˜ï¼ˆæ¥æº/æ•°æ®/è¿‡æœŸæ—¶é—´ï¼‰ |
| `Data/Entities/UserEntity.cs` | ç”¨æˆ·è´¦æˆ·ï¼ˆç”¨æˆ·å/bcrypt å¯†ç å“ˆå¸Œï¼‰ |

### Middleware

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Middleware/CorrelationIdMiddleware.cs` | ä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ  `X-Correlation-ID` è¯·æ±‚è¿½è¸ª ID |
| `Middleware/ExceptionHandlerMiddleware.cs` | å…¨å±€å¼‚å¸¸æ•è·ï¼Œè¿”å›æ ‡å‡†åŒ–é”™è¯¯ JSON |
| `Middleware/PerformanceMonitoringMiddleware.cs` | è®°å½•è¯·æ±‚è€—æ—¶ï¼Œæ·»åŠ  `X-Response-Time-Ms` å“åº”å¤´ |
| `Middleware/RequestResponseLoggingMiddleware.cs` | è®°å½•è¯·æ±‚/å“åº”æ—¥å¿—ï¼ˆè·¯å¾„/çŠ¶æ€ç /è€—æ—¶ï¼‰ |

### Models

| æ–‡ä»¶/ç›®å½• | è¯´æ˜ |
|-----------|------|
| `Models/AnimeResponse.cs` | åŠ¨æ¼«åˆ—è¡¨å“åº”ï¼ˆå«æ•°æ®æ¥æºæ ‡è¯†ï¼šDB/APIï¼‰ |
| `Models/PreFetchStatus.cs` | é¢„å–æœåŠ¡çŠ¶æ€ï¼ˆè¿è¡Œä¸­/ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´/ç»Ÿè®¡ï¼‰ |
| `Models/ErrorResponse.cs` | æ ‡å‡†é”™è¯¯å“åº”æ ¼å¼ |
| `Models/TMDBAnimeInfo.cs` | TMDB æœç´¢ç»“æœæ˜ å°„æ¨¡å‹ |
| `Models/AniListAnimeInfo.cs` | AniList GraphQL å“åº”æ˜ å°„ |
| `Models/Dtos/AnimeInfoDto.cs` | èšåˆåŠ¨æ¼«ä¿¡æ¯ DTOï¼ˆå‰ç«¯å±•ç¤ºç”¨ï¼‰ |
| `Models/Dtos/AnimeImagesDto.cs` | å›¾ç‰‡ DTO |
| `Models/Dtos/ApiResponseDto.cs` | ç»Ÿä¸€ API å“åº”åŒ…è£… `{ success, data, error }` |
| `Models/Dtos/BangumiAnimeDto.cs` | Bangumi ç•ªå‰§ DTO |
| `Models/Dtos/ExternalUrlsDto.cs` | å¤–éƒ¨é“¾æ¥ï¼ˆBangumi/TMDB/AniList/MAL URLï¼‰ |
| `Models/Dtos/MikanSearchDtos.cs` | Mikan æœç´¢ç»“æœ DTOï¼ˆç•ªå‰§åˆ—è¡¨/å­—å¹•ç»„ï¼‰ |
| `Models/Dtos/SubscriptionDtos.cs` | è®¢é˜…è¯·æ±‚/å“åº” DTO |
| `Models/Jikan/JikanModels.cs` | Jikan API å“åº”æ¨¡å‹ |
| `Models/Mikan/MikanRssModels.cs` | Mikan RSS XML è§£ææ¨¡å‹ |
| `Models/Configuration/ApiConfiguration.cs` | TMDB/Jikan API é…ç½®ç±» |
| `Models/Configuration/MikanConfiguration.cs` | Mikan è½®è¯¢é…ç½®ç±» |
| `Models/Configuration/QBittorrentConfiguration.cs` | qBittorrent è¿æ¥é…ç½®ç±» |

### æ ¹ç›®å½•é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Program.cs` | åº”ç”¨å¯åŠ¨ï¼šDI æ³¨å†Œã€ä¸­é—´ä»¶ç®¡é“ã€æ•°æ®åº“åˆå§‹åŒ– |
| `appsettings.json` | é»˜è®¤é…ç½®ï¼ˆæ—¥å¿—çº§åˆ«ã€API åœ°å€ã€é»˜è®¤å€¼ï¼‰ |
| `appsettings.Development.json` | å¼€å‘ç¯å¢ƒè¦†ç›–é…ç½® |
| `appsettings.runtime.json` | å®‰è£…å‘å¯¼å†™å…¥çš„è¿è¡Œæ—¶é…ç½®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ |

---

## å‰ç«¯æ–‡ä»¶æ¸…å•

### å…¥å£ & è·¯ç”±

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `main.tsx` | React åº”ç”¨å…¥å£ï¼ŒæŒ‚è½½ `<App />` åˆ° `#root` |
| `App.tsx` | æ ¹ç»„ä»¶ï¼šè·¯ç”±é…ç½®ï¼ˆRouterProviderï¼‰ã€è®¤è¯çŠ¶æ€æ£€æŸ¥ã€ProtectedRoute |
| `index.css` | å…¨å±€æ ·å¼ + Tailwind CSS + è‡ªå®šä¹‰ CSS ç±»ï¼ˆ`.sidebar-header`ã€`.content-header`ï¼‰ |
| `config/env.ts` | ç¯å¢ƒå˜é‡è¯»å–ï¼ˆAPI base URL ç­‰ï¼‰ |

### State Management

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `stores/useAppStores.tsx` | Zustand storeï¼ŒæŒä¹…åŒ–åˆ° localStorage (`anime-app-storage`)ï¼šè¯­è¨€(zh/en)ã€ç”¨æˆ·åã€Modal å¼€å…³çŠ¶æ€ |

### Type Definitions

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `types/anime.ts` | `AnimeInfo`ã€`AnimeListResponse` ç­‰åŠ¨æ¼«ç›¸å…³ç±»å‹ |
| `types/auth.ts` | `LoginRequest`ã€`AuthStatus`ã€`SetupRequest` ç­‰è®¤è¯ç±»å‹ |
| `types/mikan.ts` | `MikanFeedItem`ã€`TorrentInfo`ã€`DownloadRequest` ç­‰ä¸‹è½½ç±»å‹ |
| `types/settings.ts` | `SettingsProfile`ã€`TokenStatus` ç­‰è®¾ç½®ç±»å‹ |
| `types/subscription.ts` | `Subscription`ã€`SubscriptionRequest`ã€`DownloadHistory` ç­‰è®¢é˜…ç±»å‹ |

### API Services

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `services/apiClient.ts` | æ ¸å¿ƒ HTTP å°è£…ï¼š`authFetch()`ï¼Œè‡ªåŠ¨é™„åŠ  Bearer Tokenï¼Œ401 æ—¶æ¸…é™¤ Token å¹¶è·³è½¬ç™»å½• |
| `services/authApi.ts` | è®¤è¯æ¥å£ï¼š`login()`ã€`getStatus()`ã€`setup()`ã€`changeCredentials()` |
| `services/subscriptionApi.ts` | è®¢é˜…æ¥å£ï¼šCRUDã€`toggle()`ã€`check()`ã€`getHistory()` |
| `services/mikanApi.ts` | Mikan æ¥å£ï¼š`search()`ã€`getFeed()`ã€`download()`ã€`getTorrents()`ã€ç§å­æ§åˆ¶ |
| `services/settingsApi.ts` | è®¾ç½®æ¥å£ï¼š`getProfile()`ã€`saveProfile()`ã€`testQBittorrent()`ã€Token ç®¡ç† |

### Utility Functions

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `utils/formatFileSize.ts` | å°†å­—èŠ‚æ•°æ ¼å¼åŒ–ä¸ºäººç±»å¯è¯»å­—ç¬¦ä¸²ï¼ˆKB/MB/GBï¼‰ |
| `utils/torrentState.ts` | qBittorrent ç§å­çŠ¶æ€æšä¸¾åŠçŠ¶æ€æ–‡å­—/é¢œè‰²æ˜ å°„ |

### é€šç”¨ç»„ä»¶ (components/common)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `common/ErrorMessage.tsx` | é”™è¯¯ä¿¡æ¯å±•ç¤ºç»„ä»¶ï¼Œå«é‡è¯•æŒ‰é’® |
| `common/LoadingSpinner.tsx` | åŠ è½½åŠ¨ç”»ç»„ä»¶ |
| `common/ToastContainer.tsx` | Toast é€šçŸ¥å®¹å™¨ï¼ˆå…¨å±€æ¶ˆæ¯æç¤ºï¼‰ |

### å›¾æ ‡ç»„ä»¶ (components/icons)

18 ä¸ªçº¯ SVG å›¾æ ‡ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š`HomeIcon`ã€`DownloadIcon`ã€`SettingIcon`ã€`SidebarIcon`ã€`LanguageToggleIcon`ã€`LogoutIcon`ã€`GithubIcon`ã€`BellIcon`ã€`CheckIcon`ã€`CloseIcon`ã€`ExternalLinkIcon`ã€`EyeClosedIcon`ã€`EyeOpenIcon`ã€`PlayTriangleIcon`ã€`SearchIcon`ã€`ShuffleIcon`ã€`StarIcon`

### è®¤è¯åŠŸèƒ½ (features/auth)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `features/auth/components/LoginBlock.tsx` | ç™»å½•è¡¨å•ï¼šç”¨æˆ·å/å¯†ç è¾“å…¥ã€ç™»å½•æŒ‰é’®ã€é”™è¯¯æç¤ºã€èƒŒæ™¯å›¾å±•ç¤º |

### å®‰è£…å‘å¯¼åŠŸèƒ½ (features/setup)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `features/setup/SetupPage.tsx` | 5 æ­¥å®‰è£…å‘å¯¼ï¼šåˆ›å»ºè´¦æˆ·â†’qBittorrentâ†’TMDBâ†’åå¥½è®¾ç½®â†’éªŒè¯ |

### ä¸»åŠŸèƒ½ (features/home)

**å¸ƒå±€ç»„ä»¶**

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `layout/HomePage.tsx` | ä¸»å¸ƒå±€ï¼šSidebar + å†…å®¹åŒº + React Router è·¯ç”±å‡ºå£ |
| `layout/SideBar.tsx` | å¯æŠ˜å ä¾§è¾¹æ ï¼šå¯¼èˆªé“¾æ¥ã€ç”¨æˆ·ä¿¡æ¯ã€è¯­è¨€åˆ‡æ¢ã€é€€å‡ºç™»å½• |
| `layout/SideBarButton.tsx` | ä¾§è¾¹æ æŒ‰é’®å¤ç”¨ç»„ä»¶ï¼šå›¾æ ‡+æ ‡ç­¾+æ¿€æ´»çŠ¶æ€ |

**å†…å®¹ç»„ä»¶**

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `components/HomePageContent.tsx` | ä»Šæ—¥æ”¾é€ä¸»é¡µï¼šä» API è·å–æ•°æ®ã€å±•ç¤ºå¤šä¸ª AnimeInfoFlow è½®æ’­ |
| `components/AnimeInfoFlow.tsx` | æ¨ªå‘å¯æ»šåŠ¨ç•ªå‰§å¡ç‰‡è½®æ’­ï¼Œæ”¯æŒé¼ æ ‡æ‹–æ‹½ |
| `components/AnimeCard.tsx` | å•ä¸ªç•ªå‰§å¡ç‰‡ï¼šå°é¢å›¾ã€è¯„åˆ†ã€æ ‡é¢˜ã€hover æ•ˆæœ |
| `components/AnimeDetailModal.tsx` | ç•ªå‰§è¯¦æƒ…å¼¹çª—ï¼šèƒŒæ™¯å›¾ã€åŒè¯­ç®€ä»‹ã€å¤–éƒ¨é“¾æ¥ï¼Œ`createPortal` æ¸²æŸ“ |
| `components/SearchPage.tsx` | æœç´¢é¡µé¢ï¼šMikan æœç´¢ã€RSS è¿‡æ»¤ã€èµ„æºåˆ—è¡¨ã€ä¸€é”®ä¸‹è½½ |
| `components/DownloadPage.tsx` | ä¸‹è½½ç®¡ç†é¡µï¼šqBittorrent ç§å­åˆ—è¡¨ã€è¿›åº¦ã€æš‚åœ/æ¢å¤/åˆ é™¤ |
| `components/MySubscriptionDownloadPage.tsx` | è®¢é˜…ä¸‹è½½é¡µï¼šè®¢é˜…åˆ—è¡¨ + å„è®¢é˜…ä¸‹è½½å†å² |
| `components/SubscriptionDownloadDetailModal.tsx` | è®¢é˜…è¯¦æƒ…å¼¹çª—ï¼šRSS é…ç½®ã€ä¸‹è½½å†å²è®°å½• |
| `components/SubscriptionInfo.tsx` | è®¢é˜…ä¿¡æ¯å±•ç¤ºï¼šè®¢é˜…é…ç½®æ‘˜è¦ |
| `components/DownloadActionButton.tsx` | ä¸‹è½½åŠ¨ä½œæŒ‰é’®ï¼šæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæŒ‰é’®ï¼ˆä¸‹è½½/å·²è®¢é˜…/å–æ¶ˆï¼‰ |
| `components/DownloadEpisodeGroup.tsx` | æŒ‰é›†æ•°åˆ†ç»„çš„èµ„æºåˆ—è¡¨ |
| `components/SettingPage.tsx` | è®¾ç½®é¡µé¢ï¼šqBittorrentã€TMDB Tokenã€è½®è¯¢é…ç½® |

---

## åç«¯ API å‚è€ƒ

æ‰€æœ‰ API å‡éœ€ JWT è®¤è¯ï¼ˆBearer Tokenï¼‰ï¼Œæ ‡æ³¨ `ğŸ”“` çš„ç«¯ç‚¹é™¤å¤–ã€‚

### è®¤è¯ `/api/auth`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/auth/status` | ğŸ”“ | æŸ¥è¯¢ç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–ã€å½“å‰æ˜¯å¦å·²ç™»å½• |
| `POST` | `/api/auth/login` | ğŸ”“ | ç”¨æˆ·ç™»å½•ï¼Œè¿”å› JWT Token |
| `POST` | `/api/auth/setup` | ğŸ”“ | é¦–æ¬¡å®‰è£…å‘å¯¼ï¼Œåˆ›å»ºåˆå§‹è´¦æˆ·å’Œé…ç½® |
| `POST` | `/api/auth/change-credentials` | ğŸ”’ | ä¿®æ”¹ç”¨æˆ·åæˆ–å¯†ç  |
| `GET` | `/api/auth/background` | ğŸ”“ | è·å–ç™»å½•é¡µèƒŒæ™¯å›¾ï¼ˆè¿”å›å›¾ç‰‡æ–‡ä»¶ï¼‰ |
| `POST` | `/api/auth/background` | ğŸ”’ | ä¸Šä¼ è‡ªå®šä¹‰ç™»å½•èƒŒæ™¯å›¾ |
| `DELETE` | `/api/auth/background` | ğŸ”’ | åˆ é™¤è‡ªå®šä¹‰èƒŒæ™¯å›¾ï¼Œæ¢å¤é»˜è®¤ |

### åŠ¨æ¼«æ•°æ® `/api/anime`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/anime/today` | ğŸ”’ | è·å–æœ¬å‘¨æ”¾é€ç•ªå‰§ï¼ˆDBä¼˜å…ˆï¼Œå›é€€å®æ—¶èšåˆï¼‰ |
| `GET` | `/api/anime/top/bangumi` | ğŸ”’ | Bangumi è¯„åˆ† Top 10 |
| `GET` | `/api/anime/top/anilist` | ğŸ”’ | AniList è¶‹åŠ¿ Top 10 |
| `GET` | `/api/anime/top/mal` | ğŸ”’ | MyAnimeList Top 10ï¼ˆvia Jikanï¼‰ |
| `GET` | `/api/anime/search?keyword=` | ğŸ”’ | æœç´¢åŠ¨æ¼«ï¼ˆMikan ä¸»æº + Bangumi è¡¥å……ï¼‰ |
| `GET` | `/api/anime/random` | ğŸ”’ | è·å–éšæœºæ¨èç•ªå‰§åˆ—è¡¨ |
| `POST` | `/api/anime/batch` | ğŸ”’ | æ‰¹é‡æŸ¥è¯¢ Bangumi ID å¯¹åº”çš„ç•ªå‰§ä¿¡æ¯ï¼ˆä»æœ¬åœ° DBï¼‰ |

### è®¢é˜…ç®¡ç† `/api/subscription`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/subscription` | ğŸ”’ | è·å–æ‰€æœ‰è®¢é˜…åˆ—è¡¨ |
| `GET` | `/api/subscription/{id}` | ğŸ”’ | è·å–å•ä¸ªè®¢é˜…è¯¦æƒ… |
| `GET` | `/api/subscription/bangumi/{bangumiId}` | ğŸ”’ | æŒ‰ Bangumi ID æŸ¥è¯¢è®¢é˜… |
| `POST` | `/api/subscription` | ğŸ”’ | åˆ›å»ºæ–°è®¢é˜… |
| `PUT` | `/api/subscription/{id}` | ğŸ”’ | æ›´æ–°è®¢é˜…é…ç½® |
| `DELETE` | `/api/subscription/{id}` | ğŸ”’ | åˆ é™¤è®¢é˜…ï¼ˆä¿ç•™ä¸‹è½½å†å²ï¼‰ |
| `POST` | `/api/subscription/{id}/toggle?enabled=` | ğŸ”’ | å¯ç”¨/ç¦ç”¨è®¢é˜… |
| `POST` | `/api/subscription/{id}/check` | ğŸ”’ | ç«‹å³æ‰‹åŠ¨æ£€æŸ¥è¯¥è®¢é˜… RSS |
| `POST` | `/api/subscription/check-all` | ğŸ”’ | ç«‹å³æ£€æŸ¥æ‰€æœ‰å·²å¯ç”¨è®¢é˜… |
| `POST` | `/api/subscription/ensure` | ğŸ”’ | ç¡®ä¿è®¢é˜…å­˜åœ¨ä¸”å¯ç”¨ï¼ˆå¹‚ç­‰ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰ |
| `POST` | `/api/subscription/{id}/cancel` | ğŸ”’ | å–æ¶ˆè®¢é˜…ï¼ˆå¯é€‰åˆ é™¤å·²ä¸‹è½½æ–‡ä»¶ï¼‰ |
| `GET` | `/api/subscription/{id}/history` | ğŸ”’ | è·å–è®¢é˜…ä¸‹è½½å†å² |
| `GET` | `/api/subscription/{id}/task-hashes` | ğŸ”’ | è·å–è®¢é˜…å…³è”çš„ qBittorrent ä»»åŠ¡ Hash |
| `GET` | `/api/subscription/manual-anime` | ğŸ”’ | è·å–æœ‰æ‰‹åŠ¨ä¸‹è½½ä½†æ— è®¢é˜…çš„ç•ªå‰§åˆ—è¡¨ |
| `GET` | `/api/subscription/manual-anime/{bangumiId}/history` | ğŸ”’ | è·å–ç•ªå‰§æ‰‹åŠ¨ä¸‹è½½å†å² |
| `GET` | `/api/subscription/manual-anime/{bangumiId}/task-hashes` | ğŸ”’ | è·å–æ‰‹åŠ¨ä¸‹è½½çš„ä»»åŠ¡ Hash |

### Mikan & ä¸‹è½½ `/api/mikan`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/mikan/search?keyword=` | ğŸ”’ | åœ¨ Mikan æœç´¢ç•ªå‰§ï¼Œè¿”å›æ‰€æœ‰å­£åº¦åˆ—è¡¨ |
| `GET` | `/api/mikan/search-entries?keyword=` | ğŸ”’ | æœç´¢ Mikan ç•ªå‰§æ¡ç›® |
| `POST` | `/api/mikan/correct-bangumi-id` | ğŸ”’ | ä¿®æ­£ Mikan Bangumi ID æ˜ å°„ |
| `GET` | `/api/mikan/subgroups?mikanBangumiId=` | ğŸ”’ | è·å–ç•ªå‰§çš„å­—å¹•ç»„åˆ—è¡¨ï¼ˆåç§°/IDï¼‰ |
| `GET` | `/api/mikan/feed?mikanBangumiId=&subgroupId=` | ğŸ”’ | è·å–ç•ªå‰§ RSS èµ„æºåˆ—è¡¨ï¼ˆå«é›†æ•°å½’ä¸€åŒ–ï¼‰ |
| `GET` | `/api/mikan/filter` | ğŸ”’ | æŒ‰åˆ†è¾¨ç‡/å­—å¹•ç±»å‹è¿‡æ»¤ RSS åˆ—è¡¨ |
| `POST` | `/api/mikan/download` | ğŸ”’ | å‘é€ç§å­åˆ° qBittorrent ä¸‹è½½ |
| `GET` | `/api/mikan/torrents?hashes=` | ğŸ”’ | æŸ¥è¯¢æŒ‡å®š Hash çš„ qBittorrent ä¸‹è½½çŠ¶æ€ |
| `POST` | `/api/mikan/torrents/{hash}/pause` | ğŸ”’ | æš‚åœæŒ‡å®šç§å­ |
| `POST` | `/api/mikan/torrents/{hash}/resume` | ğŸ”’ | æ¢å¤æŒ‡å®šç§å­ |
| `DELETE` | `/api/mikan/torrents/{hash}` | ğŸ”’ | åˆ é™¤æŒ‡å®šç§å­ï¼ˆå¯é€‰åˆ æ–‡ä»¶ï¼‰ |

### è®¾ç½® `/api/settings`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/settings/tokens` | ğŸ”’ | æŸ¥çœ‹ Token é…ç½®çŠ¶æ€ï¼ˆè¿”å›è„±æ•ä¿¡æ¯ï¼‰ |
| `PUT` | `/api/settings/tokens` | ğŸ”’ | æ›´æ–° TMDB Token |
| `DELETE` | `/api/settings/tokens` | ğŸ”’ | åˆ é™¤å·²å­˜å‚¨çš„ TMDB Token |
| `GET` | `/api/settings/profile` | ğŸ”’ | è·å–è®¾ç½®é¡µå®Œæ•´é…ç½®ï¼ˆqBittorrent/Mikan/Tokenï¼‰ |
| `PUT` | `/api/settings/profile` | ğŸ”’ | ä¿å­˜è®¾ç½®é¡µé…ç½® |
| `POST` | `/api/settings/test/tmdb` | ğŸ”“ | æµ‹è¯• TMDB Token æœ‰æ•ˆæ€§ |
| `POST` | `/api/settings/test/qbittorrent` | ğŸ”“ | æµ‹è¯• qBittorrent è¿æ¥ |
| `POST` | `/api/settings/test/mikan-polling` | ğŸ”“ | éªŒè¯ Mikan è½®è¯¢é—´éš”é…ç½® |

### ç®¡ç† `/api/admin`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/api/admin/prefetch/status` | ğŸ”’ | è·å–é¢„å–æœåŠ¡è¿è¡ŒçŠ¶æ€ |
| `POST` | `/api/admin/prefetch` | ğŸ”’ | æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ•°æ®é¢„å– |
| `GET` | `/api/admin/prefetch/stats` | ğŸ”’ | è·å–æ•°æ®åº“é¢„å–ç»Ÿè®¡ï¼ˆæ¡æ•°/æœ€æ–°æ—¶é—´ï¼‰ |
| `DELETE` | `/api/admin/prefetch/data` | ğŸ”’ | æ¸…ç©ºæ‰€æœ‰é¢„å–æ•°æ® |

### å¥åº·æ£€æŸ¥ `/health`

| Method | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|--------|------|------|------|
| `GET` | `/health` | ğŸ”“ | æœåŠ¡å¿ƒè·³æ£€æŸ¥ï¼Œè¿”å› `{ status: "healthy" }` |
| `GET` | `/health/dependencies` | ğŸ”’ | æ£€æŸ¥ Bangumi/TMDB/AniList è¿é€šæ€§ |

---

## æ•°æ®åº“ Schema

```
AnimeInfo          AnimeImages        Subscriptions       DownloadHistory
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BangumiId (PK)     BangumiId (PK)     Id (PK AUTO)        Id (PK AUTO)
NameJapanese       PosterUrl          BangumiId           SubscriptionId (FK)
NameChinese        BackdropUrl        Title               TorrentUrl
NameEnglish        TmdbId             MikanBangumiId      TorrentHash (UNIQUE)
DescChinese        AniListId          SubgroupId          Title
DescEnglish        CreatedAt          SubgroupName        FileSize
Score              UpdatedAt          KeywordInclude      Status (0-4)
ImagePortrait                         KeywordExclude      DownloadSource
ImageLandscape                        IsEnabled           ErrorMessage
TmdbId                                LastCheckedAt       PublishedAt
AnilistId                             LastDownloadAt      DiscoveredAt
MikanBangumiId                        DownloadCount       DownloadedAt
Weekday                               CreatedAt
AirDate                               UpdatedAt
IsPreFetched
CreatedAt/UpdatedAt


MikanFeedCache         MikanFeedItem         MikanSubgroup
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Id (PK)                Id (PK)               MikanBangumiId (PK)
MikanBangumiId         FeedCacheId (FK)      SubgroupId (PK)
SubgroupId             Title                 SubgroupName
FetchedAt              TorrentUrl            CreatedAt
ExpiresAt              TorrentHash
                       PublishedAt
                       FileSize
                       Episode

TopAnimeCache          User
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€
Id (PK)                Id (PK AUTO)
Source                 Username (UNIQUE)
DataJson               PasswordHash
FetchedAt              CreatedAt
ExpiresAt              UpdatedAt
```
